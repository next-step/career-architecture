## ğŸš€ë¯¸ì…˜
- ì´ë¦„ : ë°•ê²½ë¯¼

```text
<ê°œì„ ë°©í–¥>
1. (ì„±ëŠ¥ì´ìŠˆ) MQ send ë° consume ë°©ì‹ì„ ê°œì„ í•œë‹¤ => db connection ê°ì†Œ
    (1) MQ consumerì—ì„œ DB ì£¼ì†Œì •ë³´ ì¡°íšŒí•˜ëŠ” ë¶€ë¶„ì„ ì œê±°í•œë‹¤.
      - messageì— ì£¼ì†Œ seqê°€ ì•„ë‹Œ ì£¼ì†Œì •ë³´ stringì„ ë„˜ê²¨ì„œ MQì—ì„œëŠ” ì£¼ì†Œê²€í† ë§Œ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ì—­í• ì„ ë¶„ë¦¬í•œë‹¤.
      - ëŒ€ì‹  ì£¼ì†Œì •ë³´ insert ì²˜ë¦¬ì˜ commitì´ ì™„ë£Œëœ í›„ MQ sendí•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.(@TransactionalEventListener ì‚¬ìš©)  
    (2) MQ consumerì—ì„œ ì£¼ì†Œê²€í† ê²°ê³¼ë¥¼ bulk insert/update ë¡œ ë³€ê²½í•œë‹¤.
2. (ì™¸ë¶€ì—°ë™) ì‹¤íŒ¨ì‹œ ì¬ì²˜ë¦¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ì¶”ê°€í•œë‹¤ => ìë™í™”ë¥¼ í†µí•œ ìˆ˜ì‘ì—… ì¶•ì†Œ
    (1) message ë°œí–‰ì‹œ ì£¼ì†Œë¥¼ 100ê°œì”© ì‹¤ì–´ ë³´ë‚¸ë‹¤.
    (2) ìµœëŒ€ 3íšŒ ì¬ì‹œë„ í”„ë¡œì„¸ìŠ¤ë¥¼ ì¶”ê°€í•˜ì—¬ ì¼ì‹œì ì¸ ì‹¤íŒ¨ê±´ìˆ˜ë¥¼ ê°ì†Œì‹œí‚¨ë‹¤. 
    - ìš°ì„  ì½”ë“œë ˆë²¨ì—ì„œ ì¦‰ì‹œ ì¬ì‹œë„í•´ë³¸ë‹¤.(ì¦‰ê°ì ì¸ ì²˜ë¦¬ë¥¼ ìœ„í•´)  
    - ì‹¤ì œ ë°”ë¡œ 1ë²ˆë§Œ ì¬ì‹œë„ë§Œí•´ë„ ì„±ê³µí•˜ëŠ” ê²½ìš°ê°€ ë§ìœ¼ë¯€ë¡œ ì„±ê³µìœ¨ì„ ë†’ì¼ ìˆ˜ ìˆì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒëœë‹¤.
    (3) ì¬ì²˜ë¦¬ í”„ë¡œì„¸ìŠ¤ì—ì„œ ë¡œê·¸ì„± ë°ì´í„° ë³´ê´€ì´ í•„ìš”í•˜ë¯€ë¡œ, retry table(ì‹ ê·œ ìƒì„±)ì—ì„œ ê´€ë¦¬í•œë‹¤.
    - ì¬ì²˜ë¦¬ ê³¼ì •ì—ì„œì˜ ë©”ì‹œì§€ ìœ ì‹¤ì— ëŒ€ë¹„í•˜ì—¬(ì„œë²„ë‹¤ìš´ ë“± ëª¨ì¢…ì˜ ì´ìœ ë¡œ ì¸í•œ), retry tableì— insert í•œë‹¤.
    - ì¶”í›„ í•„ìš”í•˜ë‹¤ë©´ retry tableì—ì„œ ì¬ì²˜ë¦¬ 3íšŒê°€ ì´ë¤„ì§€ì§€ ì•Šì€ ê±´ì— ëŒ€í•´ batch ì²˜ë¦¬ë„ ìƒê°í•´ë³¸ë‹¤.
    (4) third party ë¡œì˜ í•œêº¼ë²ˆì˜ ìš”ì²­ ë¶€í•˜ë¥¼ ì¤„ì¸ë‹¤.
    - MQ consumerì—ì„œ ìŠ¤ë ˆë“œë¥¼ 1ê°œë¡œë§Œ ì„¤ì •í•˜ì—¬ message ì†Œë¹„ë¥¼ ì§ë ¬ë¡œ ì²˜ë¦¬í•˜ê²Œë” í•œë‹¤.(í˜„ì¬ëŠ” 2ê°œ) 
    
```

### TO-BE ëª…ë¶€ë“±ë¡ í”„ë¡œì„¸ìŠ¤(ìƒì„¸)

```mermaid
flowchart TB
    
%% Colors %%
classDef red fill:#FF3399,stroke:#000,stroke-width:2px,color:#fff
classDef green fill:#007700,stroke:#000,stroke-width:2px,color:#fff
classDef sky fill:#0000CD,stroke:#000,stroke-width:2px,color:#fff

    database[(database)]


    ëª…ë¶€ì—…ë¡œë“œ-->|insert|register[(ëª…ë¶€)]
    ëª…ë¶€ì—…ë¡œë“œ-->|insert|address[(ì†Œì¬ì§€)]
    register-->ëª…ë¶€ì €ì¥
    address-->ëª…ë¶€ì €ì¥
    ëª…ë¶€ì €ì¥-->|after commit|MQSender
    MQSender-.->|1ê°œì”© ìš”ì²­|MQ
    subgraph "ì†Œì¬ì§€ ì£¼ì†Œê²€í† (loop)"
        direction TB
        MQConsumer-.->MQ
        MQConsumer-->ì£¼ì†Œê²€í† 
            ì£¼ì†Œê²€í† -->|ê²€ìƒ‰ìš”ì²­|thirdParty-->|ê²€ìƒ‰ê²°ê³¼|ì´ë ¥ì €ì¥-->|insert|requestHistory[(ì£¼ì†Œê²€í† ì´ë ¥)]
        requestHistory-->Result{ì„±ê³µì—¬ë¶€}
        Result-->|yes|ê²°ê³¼ì €ì¥-->|ì£¼ì†Œê²€í† ê²°ê³¼ update|ì†Œì¬ì§€[(ì†Œì¬ì§€)]
        ê²°ê³¼ì €ì¥-->|insert|addressDetail[(ì†Œì¬ì§€ ë“±ê¸°ì •ë³´)]
        Result-->|no|ì¬ì‹œë„
        ì¬ì‹œë„-->|ì¬ì‹œë„íšŸìˆ˜ +1|retry{ì¬ì‹œë„ max ì´ˆê³¼ì—¬ë¶€}
            retry-->|yes|ê²°ê³¼ì €ì¥
            retry-->|no|ì£¼ì†Œê²€í† 
        ì†Œì¬ì§€-->ëª…ë¶€ë“±ë¡ì™„ë£Œ
        addressDetail-->ëª…ë¶€ë“±ë¡ì™„ë£Œ
        ëª…ë¶€ë“±ë¡ì™„ë£Œ-->|ëª…ë¶€ë“±ë¡ìƒíƒœ update|union[(ì¡°í•©)]
    end
    union-->ì£¼ì†Œê²€í† ê²°ê³¼{ì£¼ì†Œê²€í†  ë¯¸ì™„ë£Œê±´ ì¡´ì¬ì—¬ë¶€}
    ì£¼ì†Œê²€í† ê²°ê³¼-->|no|ëª…ë¶€ì „ë‹¬
    ì£¼ì†Œê²€í† ê²°ê³¼-->|yes|ê°œë³„ì‘ì—…
    
    thirdParty(third party):::red
    MQ(MQ):::green
```
